<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KE-WP Mapping</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
    <!-- Select2 for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- CSRF Token for AJAX requests -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body data-is-logged-in="{{ 'true' if session.get('user') else 'false' }}">
<div class="page-container">
    {% include 'components/navigation.html' %}
    <div class="container">
        <!-- Tab Switcher -->
        <div id="mapping-tab-switcher" style="display: flex; gap: 0; margin-bottom: 20px; border-bottom: 3px solid #307BBF;">
            <button type="button" class="mapping-tab active" data-tab="wp"
                    style="padding: 12px 24px; border: 1px solid #307BBF; border-bottom: none; background: #307BBF; color: white; cursor: pointer; font-size: 15px; font-weight: bold; border-radius: 8px 8px 0 0; margin-right: 4px;">
                KE-WP Mapping
            </button>
            <button type="button" class="mapping-tab" data-tab="go"
                    style="padding: 12px 24px; border: 1px solid #ccc; border-bottom: none; background: #f0f0f0; color: #666; cursor: pointer; font-size: 15px; font-weight: bold; border-radius: 8px 8px 0 0;">
                KE-GO Mapping
            </button>
        </div>

        <section>
            <h2>Step 1: Select Key Event</h2>

            <!-- AOP Filter (optional) -->
            <div class="filter-container" style="margin-bottom: 15px;">
                <label for="aop_filter" style="display: block; margin-bottom: 5px; font-weight: bold; color: #29235C;">
                    Filter by AOP (optional):
                </label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="aop_filter" name="aop_filter" style="flex: 1;">
                        <option value="">All Key Events</option>
                    </select>
                    <button type="button" id="clear_aop_filter"
                            style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; display: none;"
                            title="Clear AOP filter">
                        Clear
                    </button>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    <em>Select an AOP to show only its Key Events, or leave empty to browse all KEs</em>
                </div>
            </div>

            <!-- KE Dropdown -->
            <div class="dropdown-container">
                <label for="ke_id" style="display: block; margin-bottom: 5px; font-weight: bold; color: #29235C;">
                    Select Key Event:
                </label>
                <select id="ke_id" name="ke_id" required>
                    <option value="" disabled selected>Select a Key Event</option>
                </select>
            </div>
            <p>For detailed Key Event information, visit the <a href="/ke-details" target="_blank">Key Event details page</a>.</p>
        </section>

        <!-- WP Mapping Tab Content -->
        <div id="wp-tab-content" class="tab-content">
        <section>
            <h2>Step 2: Select Pathway</h2>

            <!-- Sub-tab navigation -->
            <div class="step2-subtabs">
                <button type="button" class="step2-subtab active" data-subtab="suggested">Suggested</button>
                <button type="button" class="step2-subtab" data-subtab="search">Search</button>
                <button type="button" class="step2-subtab" data-subtab="browse">Browse All</button>
            </div>

            <!-- Suggested panel -->
            <div class="step2-panel" id="step2-panel-suggested">
                <div id="pathway-suggestions">
                    <p style="color: #666; font-style: italic; text-align: center; padding: 20px;">Select a Key Event in Step 1 to see pathway suggestions.</p>
                </div>
            </div>

            <!-- Search panel -->
            <div class="step2-panel" id="step2-panel-search" style="display: none;">
                <div class="search-container" style="margin-bottom: 15px;">
                    <label for="pathway-search" style="display: block; margin-bottom: 5px; font-weight: bold; color: #29235C;">
                        Search Pathways:
                    </label>
                    <div style="position: relative;">
                        <input type="text" id="pathway-search" placeholder="Type to search pathways by name or description..."
                               style="width: 100%; padding: 10px 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                        <div id="search-results" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        <em>Try searching for keywords like "immune", "metabolism", "signaling", or specific gene names</em>
                    </div>
                </div>
            </div>

            <!-- Browse All panel -->
            <div class="step2-panel" id="step2-panel-browse" style="display: none;">
                <div class="dropdown-container">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #29235C;">
                        Browse all pathways:
                    </label>
                    <div id="pathway-selections">
                        <div class="pathway-selection-group" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; background: #f8fafc;">
                            <select name="wp_id" required style="width: 100%; margin-bottom: 15px;">
                                <option value="" disabled selected>Select a Pathway</option>
                            </select>
                            <div class="pathway-info" style="min-height: 100px; display: none;">
                                <!-- Pathway information will be inserted here -->
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="wp_id" name="wp_id" />
                </div>
            </div>

            <!-- Selected pathway banner (shown after clicking a suggestion) -->
            <div id="selected-pathway-banner" style="display: none;"></div>

            <p>For detailed pathway information, visit the <a href="/pw-details" target="_blank">pathway details page</a>.</p>
        </section>
        <section id="confidence-guide" style="display: none;">
            <h2>Step 3: Assess Confidence of Mappings</h2>
            <p>
                Use the guided assessment below to evaluate the biological relevance and determine the confidence level for each pathway mapping. 
                Your answers will automatically populate the confidence level and connection type fields for each individual mapping.
            </p>
            
            <div id="pathway-assessments">
                <!-- Individual pathway assessments will be inserted here -->
            </div>

            <div id="assessment-completion" style="text-align: center; margin: 20px 0; display: none;">
                <button id="complete-all-assessments" type="button" 
                        style="background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer;">
                    Complete All Assessments
                </button>
                <p id="assessment-status" style="margin-top: 10px; font-weight: bold;"></p>
            </div>
        </section>


        <section id="step-3-result" style="display: none;">
            <h2>Step 4: Assessment Results</h2>
            <p><strong>Recommended Confidence Level:</strong> <span id="auto-confidence">—</span></p>
            <p><strong>Connection Type:</strong> <span id="auto-connection">—</span></p>
            <details style="margin-top: 15px;">
                <summary style="cursor: pointer; font-weight: bold;">Understanding Confidence Levels</summary>
                <p><strong>High Confidence:</strong> Strong experimental evidence with direct pathway relationship and complete/partial coverage. Molecular-level Key Events receive additional confidence weighting.</p>
                <p><strong>Medium Confidence:</strong> Moderate experimental evidence with partial pathway relationship, or strong evidence with limited coverage. Some biological complexity or indirect connections.</p>
                <p><strong>Low Confidence:</strong> No direct experimental evidence, weak pathway relationships, or limited coverage. Computational/literature-based mappings or highly phenotypic Key Events.</p>
                <p><em>Note: Key Events at molecular, cellular, and tissue levels generally achieve higher confidence scores than organ, individual, or population-level (phenotypic) Key Events.</em></p>
            </details>

            <!-- Hidden form fields to pass values on submit -->
            <input type="hidden" id="confidence_level" name="confidence_level" value="">
            <input type="hidden" id="connection_type" name="connection_type" value="">
        </section>

        <section id="step-5-submit" style="display: none;">
            <h2>Step 5: Submit Your Mapping</h2>
            {% if session.get('user') %}
                <form id="mapping-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" disabled>Complete Assessment First</button>
                </form>
            {% else %}
                <p style="color: red; font-weight: bold;">Please <a href="{{ url_for('auth.login') }}">log in with GitHub</a> or use a <a href="{{ url_for('auth.guest_login') }}">workshop access code</a> to submit your mapping.</p>
                <button disabled>Submit KE-WP Mapping</button>
            {% endif %}
        </section>

        <div id="existing-entries"></div>
        <p id="message"></p>
        </div><!-- end wp-tab-content -->

        <!-- GO Mapping Tab Content -->
        <div id="go-tab-content" class="tab-content" style="display: none;">
        <section>
            <h2>Step 2: Browse GO Term Suggestions</h2>
            <div id="go-suggestions-container">
                <p style="color: #666; font-style: italic;">Select a Key Event above to see GO Biological Process term suggestions.</p>
            </div>
        </section>

        <section id="go-confidence-guide" style="display: none;">
            <h2>Step 3: Assess Confidence</h2>
            <p>Use the guided assessment to evaluate the GO term mapping.</p>
            <div id="go-assessment-form">
                <!-- GO assessment form will be populated by JavaScript -->
            </div>
        </section>

        <section id="go-step-result" style="display: none;">
            <h2>Step 4: Assessment Results</h2>
            <p><strong>Recommended Confidence Level:</strong> <span id="go-auto-confidence">--</span></p>
            <p><strong>Connection Type:</strong> <span id="go-auto-connection">--</span></p>
        </section>

        <section id="go-step-submit" style="display: none;">
            <h2>Step 5: Submit Your GO Mapping</h2>
            {% if session.get('user') %}
                <form id="go-mapping-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" disabled>Complete GO Assessment First</button>
                </form>
            {% else %}
                <p style="color: red; font-weight: bold;">Please <a href="{{ url_for('auth.login') }}">log in with GitHub</a> or use a <a href="{{ url_for('auth.guest_login') }}">workshop access code</a> to submit your mapping.</p>
                <button disabled>Submit KE-GO Mapping</button>
            {% endif %}
        </section>

        <div id="go-existing-entries"></div>
        <p id="go-message"></p>
        </div><!-- end go-tab-content -->

    </div>
    <footer>
        <p>&copy; 2025 KE-WP Mapping Service</p>
        <div id="data-sources-info" style="margin-top: 10px; font-size: 12px; color: #666;">
            <div style="margin-bottom: 5px;">
                <strong>Data Sources:</strong>
            </div>
            <div id="version-info" style="line-height: 1.4;">
                Loading version information...
            </div>
        </div>
    </footer>

    <!-- Thank You Modal -->
    <div id="thankYouModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 40px; max-width: 500px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); text-align: center; position: relative;">
            <button id="closeThankYouModal" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; line-height: 1;">&times;</button>

            <div style="font-size: 60px; color: #28a745; margin-bottom: 20px;">&#10004;</div>

            <h2 style="color: #29235C; margin-bottom: 15px;">Thank You!</h2>

            <p style="color: #666; font-size: 16px; margin-bottom: 25px;">
                Your mapping has been successfully submitted.
            </p>

            <div id="submissionSummary" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 25px; text-align: left;">
                <!-- Summary will be populated by JavaScript -->
            </div>

            <div style="display: flex; gap: 15px; justify-content: center;">
                <button onclick="location.reload()" style="background: #307BBF; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">
                    Submit Another
                </button>
                <button onclick="location.href='/explore'" style="background: #93D5F6; color: #29235C; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">
                    View Dataset
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>



</div>
</body>
</html>
