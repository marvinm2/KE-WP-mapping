<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KE-WP Mapping</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    
    <!-- CSRF Token for AJAX requests -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <style>
        select {
            width: 100%;
            overflow: visible;
        }

        .dropdown-container {
            width: 100%;
            overflow: visible;
        }

        .github-login {
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .github-login p {
            margin: 0;
            color: #333;
        }

        .github-login a {
            color: #307BBF;
            text-decoration: none;
            font-weight: bold;
        }

        .github-login a:hover {
            text-decoration: underline;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .page-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            flex: 1; /* Take all available space */
            padding: 20px;
        }

        .assessment-step {
            margin-bottom: 20px;
        }

        .assessment-step h4 {
            margin-bottom: 10px;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn-option {
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            background-color: #f8fafc;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #29235C;
        }

        .btn-option:hover {
            background-color: #e2e8f0;
            border-color: #307BBF;
        }

        .btn-option.selected {
            background-color: #307BBF;
            color: white;
            border-color: #307BBF;
        }

        .tooltip {
            display: inline-block;
            position: relative;
            cursor: help;
            color: #307BBF;
            margin-left: 8px;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: 120%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 8px 10px;
            border-radius: 5px;
            font-size: 13px;
            white-space: pre-line;
            max-width: 300px;
            text-align: left;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s ease;
            z-index: 10;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        /* Side-by-side layout for KE and Pathway sections */
        .selection-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .selection-section {
            flex: 1;
            min-width: 0;
        }

        .selection-section h2 {
            margin-top: 0;
        }

        /* Success message styling */
        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            display: none;
            font-weight: bold;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .success-icon {
            color: #28a745;
            font-size: 1.2em;
            margin-right: 10px;
        }

        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .selection-container {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Force grid layout for preview sections */
        .mapping-preview {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 20px !important;
        }

        .preview-section {
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Ensure preview grid is responsive */
        @media (max-width: 768px) {
            .mapping-preview {
                display: block !important;
                grid-template-columns: none !important;
            }
            
            .mapping-preview .preview-section {
                margin-bottom: 15px;
            }
            
            .preview-section[style*="grid-template-columns"] {
                display: block !important;
            }
        }

    </style>
</head>
<body data-is-logged-in="{{ 'true' if session.get('user') else 'false' }}">
<div class="page-container">
    <header>
        <h1>Map Key Events to WikiPathways</h1>
        <nav style="display: flex; justify-content: center; gap: 20px; margin-top: 10px; align-items: center; flex-wrap: wrap;">
            <button onclick="location.href='/explore'">Explore Dataset</button>
            <button onclick="location.href='/download'">Download Dataset</button>
            {% if is_admin %}
                <button onclick="location.href='/admin/proposals'" style="background-color: #EB5B25;">Admin: Manage Proposals</button>
            {% endif %}
            <div class="github-login">
                {% if session.get('user') %}
                    <p>Welcome, {{ session['user']['username'] }}
                        {% if is_admin %}
                            <span style="color: #EB5B25; font-weight: bold;">(Admin)</span>
                        {% endif %}
                    </p>
                    <a href="{{ url_for('auth.logout') }}">Logout</a>
                {% else %}
                    <a href="{{ url_for('auth.login') }}">Login with GitHub</a>
                {% endif %}
            </div>
        </nav>        
    </header>
    <div class="container">
        <section>
            <h2>Step 1: Select Key Event</h2>
            <div class="dropdown-container">
                <select id="ke_id" name="ke_id" required>
                    <option value="" disabled selected>Select a Key Event</option>
                </select>
            </div>
            <p>For detailed Key Event information, visit the <a href="/ke-details" target="_blank">Key Event details page</a>.</p>
        </section>

        <section>
            <h2>Step 2: Select Pathway</h2>
            
            <!-- Pathway Search -->
            <div class="search-container" style="margin-bottom: 15px;">
                <label for="pathway-search" style="display: block; margin-bottom: 5px; font-weight: bold; color: #29235C;">
                    üîç Search Pathways:
                </label>
                <div style="position: relative;">
                    <input type="text" id="pathway-search" placeholder="Type to search pathways by name or description..." 
                           style="width: 100%; padding: 10px 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                    <div id="search-results" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                    </div>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    üí° <em>Try searching for keywords like "immune", "metabolism", "signaling", or specific gene names</em>
                </div>
            </div>
            
            <!-- Regular Dropdown -->
            <div class="dropdown-container">
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #29235C;">
                    Or browse all pathways:
                </label>
                <div id="pathway-selections">
                    <div class="pathway-selection-group" data-index="0">
                        <div style="display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px;">
                            <select name="wp_id" required style="flex: 1;">
                                <option value="" disabled selected>Select a Pathway</option>
                            </select>
                            <button type="button" class="add-pathway-btn" onclick="window.KEWPApp.addPathwaySelection()" 
                                    style="background: #307BBF; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                +
                            </button>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="wp_id" name="wp_id" />
            </div>
            <p>For detailed pathway information, visit the <a href="/pw-details" target="_blank">pathway details page</a>.</p>
        </section>
        <section id="confidence-guide" style="display: none;">
            <h2>Step 3: Assess Confidence of Mapping</h2>
            <p>
                Use the guided assessment below to evaluate the biological relevance and determine the confidence level of your mapping. 
                Your answers will automatically populate the confidence level and connection type fields.
            </p>

            <div id="step1" class="assessment-step">
                <h4>1. Is this pathway biologically relevant to the Key Event?
                    <span class="tooltip" data-tooltip="Determine whether the selected pathway directly relates to the biological process described in the Key Event's title and description.">‚ùì</span>
                </h4>
                <div class="btn-group" data-step="step1">
                    <button class="btn-option" data-value="yes">Yes</button>
                    <button class="btn-option" data-value="no">No (Stop)</button>
                </div>
            </div>

            <div id="step2" class="assessment-step" style="display: none;">
                <h4>2. What is the relationship between the pathway and Key Event?
                    <span class="tooltip" data-tooltip="Causative: The pathway causes the Key Event to occur.\nResponsive: The pathway responds to or is activated by the Key Event.\nBidirectional: The pathway both causes and responds to the Key Event.\nUnclear: The relationship exists but the direction is not well established.">‚ùì</span>
                </h4>
                <div class="btn-group" data-step="step2">
                    <button class="btn-option" data-value="causative">Causative</button>
                    <button class="btn-option" data-value="responsive">Responsive</button>
                    <button class="btn-option" data-value="bidirectional">Bidirectional</button>
                    <button class="btn-option" data-value="unclear">Unclear</button>
                </div>
            </div>

            <div id="step3" class="assessment-step" style="display: none;">
                <h4>3. What evidence supports this mapping?
                    <span class="tooltip" data-tooltip="Strong experimental: Direct in vivo or in vitro studies showing pathway involvement in the Key Event.\nModerate experimental: Some experimental data but limited or indirect.\nComputational/literature: Bioinformatics analysis or literature inference without direct experimental validation.\nNo direct evidence: Mapping based on biological plausibility only.">‚ùì</span>
                </h4>
                <div class="btn-group" data-step="step3">
                    <button class="btn-option" data-value="strong">Strong experimental</button>
                    <button class="btn-option" data-value="moderate">Moderate experimental</button>
                    <button class="btn-option" data-value="computational">Computational/literature</button>
                    <button class="btn-option" data-value="none">No direct evidence</button>
                </div>
            </div>

            <div id="step4" class="assessment-step" style="display: none;">
                <h4>4. How closely does the pathway relate to this Key Event?
                    <span class="tooltip" data-tooltip="Direct relationship: The pathway is central to this Key Event mechanism.\nPartial relationship: The pathway is involved but also performs other functions.\nWeak relationship: The pathway is only loosely connected to this Key Event.">‚ùì</span>
                </h4>
                <div class="btn-group" data-step="step4">
                    <button class="btn-option" data-value="direct">Direct relationship</button>
                    <button class="btn-option" data-value="partial">Partial relationship</button>
                    <button class="btn-option" data-value="weak">Weak relationship</button>
                </div>
            </div>

            <div id="step5" class="assessment-step" style="display: none;">
                <h4>5. How comprehensive is the pathway coverage of the Key Event?
                    <span class="tooltip" data-tooltip="Complete: The pathway fully explains the Key Event mechanism.\nPartial: The pathway explains major aspects of the Key Event.\nLimited: The pathway explains only minor aspects of the Key Event.">‚ùì</span>
                </h4>
                <div class="btn-group" data-step="step5">
                    <button class="btn-option" data-value="complete">Complete coverage</button>
                    <button class="btn-option" data-value="partial">Partial coverage</button>
                    <button class="btn-option" data-value="limited">Limited coverage</button>
                </div>
            </div>

            <button id="evaluateBtn" type="button" style="display: none;" onclick="evaluateConfidence()">Complete Assessment</button>

            <p id="ca-result" style="font-weight: bold; margin-top: 10px;"></p>
        </section>


        <section id="step-3-result">
            <h2>Step 4: Assessment Results</h2>
            <p><strong>Recommended Confidence Level:</strong> <span id="auto-confidence">‚Äî</span></p>
            <p><strong>Connection Type:</strong> <span id="auto-connection">‚Äî</span></p>
            <details style="margin-top: 15px;">
                <summary style="cursor: pointer; font-weight: bold;">Understanding Confidence Levels</summary>
                <p><strong>High Confidence:</strong> Strong experimental evidence with direct pathway relationship and complete/partial coverage. Molecular-level Key Events receive additional confidence weighting.</p>
                <p><strong>Medium Confidence:</strong> Moderate experimental evidence with partial pathway relationship, or strong evidence with limited coverage. Some biological complexity or indirect connections.</p>
                <p><strong>Low Confidence:</strong> No direct experimental evidence, weak pathway relationships, or limited coverage. Computational/literature-based mappings or highly phenotypic Key Events.</p>
                <p><em>Note: Key Events at molecular, cellular, and tissue levels generally achieve higher confidence scores than organ, individual, or population-level (phenotypic) Key Events.</em></p>
            </details>

            <!-- Hidden form fields to pass values on submit -->
            <input type="hidden" id="confidence_level" name="confidence_level" value="">
            <input type="hidden" id="connection_type" name="connection_type" value="">
        </section>

        <section>
            <h2>Step 5: Submit Your Mapping</h2>
            {% if session.get('user') %}
                <form id="mapping-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit">Submit KE-WP Mapping</button>
                </form>
            {% else %}
                <p style="color: red; font-weight: bold;">Please log in with GitHub to submit your mapping.</p>
                <button disabled>Submit KE-WP Mapping</button>
            {% endif %}
        </section>        

        <div id="existing-entries"></div>
        <p id="message"></p>
    </div>
    <footer>
        <p>&copy; 2025 KE-WP Mapping Service</p>
        <div id="data-sources-info" style="margin-top: 10px; font-size: 12px; color: #666;">
            <div style="margin-bottom: 5px;">
                <strong>Data Sources:</strong>
            </div>
            <div id="version-info" style="line-height: 1.4;">
                Loading version information...
            </div>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    
    
</div>
</body>
</html>
