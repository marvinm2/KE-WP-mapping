<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KE-WP Mapping</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    
    <!-- CSRF Token for AJAX requests -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <style>
        select {
            width: 100%;
            overflow: visible;
        }

        .dropdown-container {
            width: 100%;
            overflow: visible;
        }

        .github-login {
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .github-login p {
            margin: 0;
            color: #333;
        }

        .github-login a {
            color: #307BBF;
            text-decoration: none;
            font-weight: bold;
        }

        .github-login a:hover {
            text-decoration: underline;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .page-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            flex: 1; /* Take all available space */
            padding: 20px;
        }

        .assessment-step {
            margin-bottom: 20px;
        }

        .assessment-step h4 {
            margin-bottom: 10px;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn-option {
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            background-color: #f8fafc;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #29235C;
        }

        .btn-option:hover {
            background-color: #e2e8f0;
            border-color: #307BBF;
        }

        .btn-option.selected {
            background-color: #307BBF;
            color: white;
            border-color: #307BBF;
        }

        .tooltip {
            display: inline-block;
            position: relative;
            cursor: help;
            color: #307BBF;
            margin-left: 8px;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: 120%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 8px 10px;
            border-radius: 5px;
            font-size: 13px;
            white-space: pre-line;
            max-width: 300px;
            text-align: left;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s ease;
            z-index: 10;
        }

        .tooltip:hover::after {
            opacity: 1;
        }


    </style>
</head>
<body data-is-logged-in="{{ 'true' if session.get('user') else 'false' }}">
<div class="page-container">
    <header>
        <h1>Map Key Events to WikiPathways</h1>
        <nav style="display: flex; justify-content: center; gap: 20px; margin-top: 10px; align-items: center; flex-wrap: wrap;">
            <button onclick="location.href='/explore'">Explore Dataset</button>
            <button onclick="location.href='/download'">Download Dataset</button>
            {% if is_admin %}
                <button onclick="location.href='/admin/proposals'" style="background-color: #EB5B25;">Admin: Manage Proposals</button>
            {% endif %}
            <div class="github-login">
                {% if session.get('user') %}
                    <p>Welcome, {{ session['user']['username'] }}
                        {% if is_admin %}
                            <span style="color: #EB5B25; font-weight: bold;">(Admin)</span>
                        {% endif %}
                    </p>
                    <a href="{{ url_for('logout') }}">Logout</a>
                {% else %}
                    <a href="{{ url_for('login') }}">Login with GitHub</a>
                {% endif %}
            </div>
        </nav>        
    </header>
    <div class="container">
        <section>
            <h2>Step 1: Select Key Event</h2>
            <div class="dropdown-container">
                <select id="ke_id" name="ke_id" required>
                    <option value="" disabled selected>Select a Key Event</option>
                </select>
            </div>
            <p>For detailed Key Event information, visit the <a href="/ke-details" target="_blank">Key Event details page</a>.</p>
        </section>

        <section>
            <h2>Step 2: Select Pathway</h2>
            <div class="dropdown-container">
                <select id="wp_id" name="wp_id" required>
                    <option value="" disabled selected>Select a Pathway</option>
                </select>
            </div>
            <p>For detailed pathway information, visit the <a href="/pw-details" target="_blank">pathway details page</a>.</p>
        </section>
        <section id="confidence-guide" style="display: none;">
            <h2>Step 3: Assess Confidence of Mapping</h2>
            <p>
                Use the guided assessment below to evaluate the biological relevance and determine the confidence level of your mapping. 
                Your answers will automatically populate the confidence level and connection type fields.
            </p>

            <div id="step1" class="assessment-step">
                <h4>1. Is the pathway biologically related to the Key Event?
                    <span class="tooltip" data-tooltip="Determine whether the selected pathway directly relates to the biological process described in the Key Event's title and description.">❓</span>
                </h4>
                <div class="btn-group" data-step="step1">
                    <button class="btn-option" data-value="yes">Yes</button>
                    <button class="btn-option" data-value="no">No (Stop)</button>
                </div>
            </div>


            <div id="step2" class="assessment-step" style="display: none;">
                <h4>2. What is the biological level of the Key Event?
                    <span class="tooltip" data-tooltip="Key Events at molecular, cellular, tissue, or organ levels are eligible for higher confidence mappings than those at individual or population levels.">❓</span>
                </h4>
                <div class="btn-group" data-step="step2">
                    <button class="btn-option" data-value="yes">Yes</button>
                    <button class="btn-option" data-value="no">No</button>
                </div>
            </div>

            <div id="step3" class="assessment-step" style="display: none;">
                <h4>3. Is there evidence linking the pathway to the Key Event?
                    <span class="tooltip" data-tooltip="Look for experimental evidence (in vitro or in vivo) demonstrating that this pathway is activated, modified, or otherwise responds when the Key Event occurs.">❓</span>
                </h4>
                <div class="btn-group" data-step="step3">
                    <button class="btn-option" data-value="yes">Yes</button>
                    <button class="btn-option" data-value="no">No</button>
                </div>
            </div>

            <div id="step4" class="assessment-step" style="display: none;">
                <h4>4. How well does the pathway match the Key Event?
                    <span class="tooltip" data-tooltip="Evaluate whether the pathway is a close or complete match to the Key Event. Consider the specificity and comprehensiveness of the biological overlap.">❓</span>
                </h4>
                <div class="btn-group" data-step="step4">
                    <button class="btn-option" data-value="yes">Yes</button>
                    <button class="btn-option" data-value="no">No</button>
                </div>
            </div>

            <div id="step5" class="assessment-step" style="display: none;">
                <h4>5. How specific is the pathway to the Key Event?
                    <span class="tooltip" data-tooltip="Assess whether the relevant pathway components function independently or are part of broader signaling networks. More specific pathways receive higher confidence ratings.">❓</span>
                </h4>
                <div class="btn-group" data-step="step5">
                    <button class="btn-option" data-value="high">Highly specific</button>
                    <button class="btn-option" data-value="medium">Relevant but partial</button>
                    <button class="btn-option" data-value="low">Minor or indirect</button>
                </div>
            </div>

            <div id="step6" class="assessment-step" style="display: none;">
                <h4>6. Can the relevant pathway components function independently?
                    <span class="tooltip" data-tooltip="Determine if the pathway components relevant to the Key Event can operate as a discrete, modular unit, or if they require extensive integration with other biological processes.">❓</span>
                </h4>
                <div class="btn-group" data-step="step6">
                    <button class="btn-option" data-value="yes">Yes</button>
                    <button class="btn-option" data-value="no">No</button>
                </div>
            </div>

            <div id="step2b" class="assessment-step" style="display: none;">
                <h4>What is the relationship between the pathway and Key Event?
                    <span class="tooltip" data-tooltip="Determine if the pathway causes the Key Event to occur (causative), responds to the Key Event after it happens (responsive), or has another type of relationship.">❓</span>
                </h4>
                <div class="btn-group" data-step="step2b">
                    <button class="btn-option" data-value="causative">Causative</button>
                    <button class="btn-option" data-value="responsive">Responsive</button>
                    <button class="btn-option" data-value="other">Undefined</button>
                </div>
            </div>

            <button id="evaluateBtn" type="button" style="display: none;" onclick="evaluateConfidence()">Complete Assessment</button>

            <p id="ca-result" style="font-weight: bold; margin-top: 10px;"></p>
        </section>


        <section id="step-3-result">
            <h2>Step 4: Assessment Results</h2>
            <p><strong>Recommended Confidence Level:</strong> <span id="auto-confidence">—</span></p>
            <p><strong>Connection Type:</strong> <span id="auto-connection">—</span></p>
            <details style="margin-top: 15px;">
                <summary style="cursor: pointer; font-weight: bold;">Understanding Confidence Levels</summary>
                <p><strong>High Confidence:</strong> Direct and specific biological link with strong experimental evidence. The pathway components function independently and specifically relate to the Key Event.</p>
                <p><strong>Medium Confidence:</strong> Partial or indirect biological relationship with moderate evidence. May involve pathway integration or some biological complexity.</p>
                <p><strong>Low Confidence:</strong> Weak, speculative, or unclear biological connection. Limited experimental support or only minor overlap between pathway and Key Event.</p>
            </details>

            <!-- Hidden form fields to pass values on submit -->
            <input type="hidden" id="confidence_level" name="confidence_level" value="">
            <input type="hidden" id="connection_type" name="connection_type" value="">
        </section>

        <section>
            <h2>Step 5: Submit Your Mapping</h2>
            {% if session.get('user') %}
                <form id="mapping-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit">Submit KE-WP Mapping</button>
                </form>
            {% else %}
                <p style="color: red; font-weight: bold;">Please log in with GitHub to submit your mapping.</p>
                <button disabled>Submit KE-WP Mapping</button>
            {% endif %}
        </section>        

        <div id="existing-entries"></div>
        <p id="message"></p>
    </div>
    <footer>
        <p>&copy; 2025 KE-WP Mapping Service</p>
    </footer>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    
    
</div>
</body>
</html>
