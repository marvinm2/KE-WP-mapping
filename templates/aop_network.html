<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOP Network Visualization</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    
    <!-- Cytoscape.js -->
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-cose-bilkent@4.1.0/cytoscape-cose-bilkent.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <style>
        .network-container {
            display: flex;
            height: calc(100vh - 140px);
            gap: 20px;
            margin: 20px;
        }
        
        .control-panel {
            width: 300px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        
        .network-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        #cy {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        
        .aop-selector {
            margin-bottom: 20px;
        }
        
        .aop-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .legend {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }
        
        .stats {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 5px;
            border-left: 4px solid #307BBF;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            display: none;
            background: #fee;
            color: #d32f2f;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .layout-controls {
            margin-bottom: 20px;
        }
        
        .layout-controls button {
            background: #307BBF;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .layout-controls button:hover {
            background: #2563eb;
        }
        
        .node-info {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 5px;
            display: none;
        }
        
        .node-info h4 {
            margin: 0 0 10px 0;
            color: #307BBF;
        }
        
        .node-info p {
            margin: 5px 0;
            font-size: 13px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <header>
        <h1>AOP Network Visualization</h1>
        <nav style="display: flex; justify-content: center; gap: 20px; margin-top: 10px;">
            <button onclick="location.href='/'">Add New Mapping</button>
            <button onclick="location.href='/explore'">Explore Dataset</button>
            <button onclick="location.href='/download'">Download Dataset</button>
        </nav>
    </header>
    
    <div class="network-container">
        <div class="control-panel">
            <h3>AOP Selection</h3>
            <div class="aop-selector">
                <select id="aop-select">
                    <option value="">Select an Adverse Outcome Pathway...</option>
                </select>
            </div>
            
            <div class="loading" id="loading">
                <p>Loading network data...</p>
                <div style="margin: 10px 0;">‚è≥</div>
            </div>
            
            <div class="error" id="error-message"></div>
            
            <div class="layout-controls" id="layout-controls" style="display: none;">
                <h4>Layout Options</h4>
                <button onclick="applyLayout('cose-bilkent')">Hierarchical</button>
                <button onclick="applyLayout('grid')">Grid</button>
                <button onclick="applyLayout('circle')">Circle</button>
                <button onclick="applyLayout('concentric')">Concentric</button>
                <button onclick="resetZoom()">Reset Zoom</button>
            </div>
            
            <div class="legend" id="legend" style="display: none;">
                <h4>Key Event Types</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #22c55e;"></div>
                    <span>Molecular Initiating Event (MIE)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ef4444;"></div>
                    <span>Adverse Outcome (AO)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #eab308;"></div>
                    <span>Intermediate Key Event</span>
                </div>
            </div>
            
            <div class="stats" id="stats" style="display: none;">
                <h4>Network Statistics</h4>
                <div class="stat-item">
                    <span>Key Events:</span>
                    <span id="node-count">0</span>
                </div>
                <div class="stat-item">
                    <span>Relationships:</span>
                    <span id="edge-count">0</span>
                </div>
                <div class="stat-item">
                    <span>MIE Count:</span>
                    <span id="mie-count">0</span>
                </div>
                <div class="stat-item">
                    <span>AO Count:</span>
                    <span id="ao-count">0</span>
                </div>
            </div>
            
            <div class="node-info" id="node-info">
                <h4>Key Event Details</h4>
                <p id="node-title"></p>
                <p id="node-label"></p>
                <p id="node-bio-level"></p>
                <p id="node-type"></p>
            </div>
        </div>
        
        <div class="network-panel">
            <div id="cy"></div>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2025 KE-WP Mapping Service - AOP Network Visualization</p>
    </footer>
    
    <script>
        let cy;
        let currentNetworkData = null;
        
        $(document).ready(function() {
            loadAOPOptions();
            initializeCytoscape();
        });
        
        function loadAOPOptions() {
            $.get('/get_aop_options')
                .done(function(data) {
                    const select = $('#aop-select');
                    select.empty().append('<option value="">Select an Adverse Outcome Pathway...</option>');
                    
                    data.forEach(function(aop) {
                        const option = $('<option></option>')
                            .val(aop.AOPpage)
                            .text(aop.AOPtitle + ' (' + aop.AOPlabel + ')');
                        select.append(option);
                    });
                })
                .fail(function() {
                    showError('Failed to load AOP options. Please refresh the page.');
                });
        }
        
        function initializeCytoscape() {
            cy = cytoscape({
                container: document.getElementById('cy'),
                
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': function(ele) {
                                const keClass = ele.data('ke_class');
                                switch(keClass) {
                                    case 'mie': return '#22c55e'; // green
                                    case 'ao': return '#ef4444'; // red
                                    default: return '#eab308'; // yellow
                                }
                            },
                            'label': 'data(label)',
                            'width': 60,
                            'height': 60,
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'color': '#fff',
                            'text-outline-width': 2,
                            'text-outline-color': '#000',
                            'font-size': '12px',
                            'text-wrap': 'wrap',
                            'text-max-width': '80px',
                            'border-width': 2,
                            'border-color': '#333'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': '#666',
                            'target-arrow-color': '#666',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'border-width': 4,
                            'border-color': '#307BBF'
                        }
                    }
                ],
                
                layout: {
                    name: 'cose-bilkent',
                    idealEdgeLength: 100,
                    nodeOverlap: 20,
                    refresh: 30,
                    randomize: false
                }
            });
            
            // Node click handler
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                showNodeInfo(node.data());
            });
        }
        
        $('#aop-select').change(function() {
            const aopId = $(this).val();
            if (aopId) {
                loadAOPNetwork(aopId);
            } else {
                clearNetwork();
            }
        });
        
        function loadAOPNetwork(aopId) {
            showLoading(true);
            hideError();
            clearNetwork();
            
            $.get('/get_aop_network/' + encodeURIComponent(aopId))
                .done(function(data) {
                    currentNetworkData = data;
                    displayNetwork(data);
                    updateStatistics(data);
                    showControls(true);
                })
                .fail(function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to load network data';
                    showError(error);
                })
                .always(function() {
                    showLoading(false);
                });
        }
        
        function displayNetwork(data) {
            const elements = [];
            
            // Add nodes
            data.nodes.forEach(function(node) {
                elements.push({
                    data: {
                        id: node.id,
                        label: node.label || node.title,
                        title: node.title,
                        bio_level: node.bio_level,
                        ke_type: node.ke_type,
                        ke_class: node.ke_class
                    }
                });
            });
            
            // Add edges
            data.edges.forEach(function(edge, index) {
                elements.push({
                    data: {
                        id: 'edge_' + index,
                        source: edge.source,
                        target: edge.target,
                        type: edge.type
                    }
                });
            });
            
            cy.elements().remove();
            cy.add(elements);
            cy.layout({
                name: 'cose-bilkent',
                idealEdgeLength: 100,
                nodeOverlap: 20,
                refresh: 30,
                randomize: false
            }).run();
        }
        
        function applyLayout(layoutName) {
            if (!cy.elements().length) return;
            
            const layoutOptions = {
                'cose-bilkent': {
                    name: 'cose-bilkent',
                    idealEdgeLength: 100,
                    nodeOverlap: 20,
                    refresh: 30
                },
                'grid': {
                    name: 'grid',
                    rows: Math.ceil(Math.sqrt(cy.nodes().length))
                },
                'circle': {
                    name: 'circle',
                    radius: 200
                },
                'concentric': {
                    name: 'concentric',
                    concentric: function(node) {
                        const keClass = node.data('ke_class');
                        switch(keClass) {
                            case 'mie': return 3;
                            case 'ao': return 1;
                            default: return 2;
                        }
                    }
                }
            };
            
            cy.layout(layoutOptions[layoutName] || layoutOptions['cose-bilkent']).run();
        }
        
        function resetZoom() {
            cy.fit();
        }
        
        function updateStatistics(data) {
            const mieCount = data.nodes.filter(n => n.ke_class === 'mie').length;
            const aoCount = data.nodes.filter(n => n.ke_class === 'ao').length;
            
            $('#node-count').text(data.node_count);
            $('#edge-count').text(data.edge_count);
            $('#mie-count').text(mieCount);
            $('#ao-count').text(aoCount);
        }
        
        function showNodeInfo(nodeData) {
            $('#node-title').html('<strong>Title:</strong> ' + (nodeData.title || 'N/A'));
            $('#node-label').html('<strong>Label:</strong> ' + (nodeData.label || 'N/A'));
            $('#node-bio-level').html('<strong>Biological Level:</strong> ' + (nodeData.bio_level || 'N/A'));
            $('#node-type').html('<strong>Type:</strong> ' + (nodeData.ke_class.toUpperCase() || 'N/A'));
            $('#node-info').show();
        }
        
        function showLoading(show) {
            if (show) {
                $('#loading').show();
            } else {
                $('#loading').hide();
            }
        }
        
        function showError(message) {
            $('#error-message').text(message).show();
        }
        
        function hideError() {
            $('#error-message').hide();
        }
        
        function showControls(show) {
            if (show) {
                $('#layout-controls').show();
                $('#legend').show();
                $('#stats').show();
            } else {
                $('#layout-controls').hide();
                $('#legend').hide();
                $('#stats').hide();
                $('#node-info').hide();
            }
        }
        
        function clearNetwork() {
            if (cy) {
                cy.elements().remove();
            }
            showControls(false);
            currentNetworkData = null;
        }
    </script>
</body>
</html>