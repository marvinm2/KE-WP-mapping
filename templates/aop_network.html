<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOP Network Visualization</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    
    <!-- jQuery (must load first) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Cytoscape.js -->
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    
    <!-- Dagre layout extension (matching your other service) -->
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    
    <!-- CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <style>
        .network-container {
            display: flex;
            height: calc(100vh - 140px);
            gap: 20px;
            margin: 20px;
        }
        
        .control-panel {
            width: 300px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        
        .network-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        #cy {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        
        .aop-selector {
            margin-bottom: 20px;
        }
        
        .aop-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .legend {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }
        
        .stats {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 5px;
            border-left: 4px solid #307BBF;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            display: none;
            background: #fee;
            color: #d32f2f;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .control-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 5px;
            border-left: 4px solid #307BBF;
        }
        
        .control-section h4 {
            margin: 0 0 10px 0;
            color: #307BBF;
            font-size: 14px;
        }
        
        .control-section button {
            background: #307BBF;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            position: relative;
        }
        
        .control-section button:hover {
            background: #2563eb;
        }
        
        .control-section button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }
        
        .dropdown-content a {
            color: #374151;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            font-size: 12px;
        }
        
        .dropdown-content a:hover {
            background-color: #f3f4f6;
        }
        
        .status-text {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        
        .node-info {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 5px;
            display: none;
        }
        
        .node-info h4 {
            margin: 0 0 10px 0;
            color: #307BBF;
        }
        
        .node-info p {
            margin: 5px 0;
            font-size: 13px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <header>
        <h1>AOP Network Visualization</h1>
        <nav style="display: flex; justify-content: center; gap: 20px; margin-top: 10px;">
            <button onclick="location.href='/'">Add New Mapping</button>
            <button onclick="location.href='/explore'">Explore Dataset</button>
            <button onclick="location.href='/download'">Download Dataset</button>
        </nav>
    </header>
    
    <div class="network-container">
        <div class="control-panel">
            <h3>AOP Selection</h3>
            <div class="aop-selector">
                <select id="aop-select">
                    <option value="">Select an Adverse Outcome Pathway...</option>
                </select>
            </div>
            
            <div class="loading" id="loading">
                <p>Loading network data...</p>
                <div style="margin: 10px 0;">‚è≥</div>
            </div>
            
            <div class="error" id="error-message"></div>
            
            <div class="control-section" id="gene-controls" style="display: none;">
                <h4>Gene Integration</h4>
                <label>
                    <input type="checkbox" id="include-genes-toggle"> 
                    Include Genes (Molecular Networks)
                </label>
                <div id="gene-info" style="margin-top: 5px; font-size: 12px; color: #666;">
                    <span id="gene-count-display" style="display: none;">Genes: <span id="gene-count">0</span></span>
                </div>
            </div>

            <div class="control-section" id="layout-controls" style="display: none;">
                <h4>Network Layout</h4>
                <button id="optimize-layout-btn" onclick="optimizeLayout()">
                    <span class="btn-text">Optimize Layout</span>
                    <span class="spinner" style="display:none;">‚ü≥</span>
                </button>
                <div id="layout-status" class="status-text" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
                <button onclick="resetZoom()" style="margin-top: 10px;">Reset Zoom</button>
            </div>

            <div class="control-section" id="export-controls" style="display: none;">
                <h4>Export Network</h4>
                <div class="dropdown">
                    <button class="dropdown-btn" onclick="toggleExportDropdown()">Export Network ‚ñº</button>
                    <div class="dropdown-content" id="export-dropdown" style="display: none;">
                        <a href="#" onclick="exportNetwork('png')">üì∑ Export as PNG</a>
                        <a href="#" onclick="exportNetwork('svg')">üé® Export as SVG</a>
                        <a href="#" onclick="exportNetwork('json')">üìÑ Network Data (JSON)</a>
                        <a href="#" onclick="exportNetwork('graphml')">üîó GraphML Format</a>
                    </div>
                </div>
                <div id="export-status" class="status-text" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
            </div>
            
            <div class="legend" id="legend" style="display: none;">
                <h4>Network Elements</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #22c55e;"></div>
                    <span>Molecular Initiating Event (MIE)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ef4444;"></div>
                    <span>Adverse Outcome (AO)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #eab308;"></div>
                    <span>Intermediate Key Event</span>
                </div>
                <div class="legend-item" id="gene-legend-item" style="display: none;">
                    <div style="width: 20px; height: 12px; background-color: #E5E7EB; border: 2px dashed #9CA3AF; margin-right: 10px; border-radius: 50%;"></div>
                    <span>Gene (from mapped pathways)</span>
                </div>
            </div>
            
            <div class="stats" id="stats" style="display: none;">
                <h4>Network Statistics</h4>
                <div class="stat-item">
                    <span>Key Events:</span>
                    <span id="node-count">0</span>
                </div>
                <div class="stat-item">
                    <span>Relationships:</span>
                    <span id="edge-count">0</span>
                </div>
                <div class="stat-item">
                    <span>MIE Count:</span>
                    <span id="mie-count">0</span>
                </div>
                <div class="stat-item">
                    <span>AO Count:</span>
                    <span id="ao-count">0</span>
                </div>
            </div>
            
            <div class="node-info" id="node-info">
                <h4>Key Event Details</h4>
                <p id="node-title"></p>
                <p id="node-label"></p>
                <p id="node-bio-level"></p>
                <p id="node-type"></p>
            </div>
        </div>
        
        <div class="network-panel">
            <div id="cy"></div>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2025 KE-WP Mapping Service - AOP Network Visualization</p>
    </footer>
    
    <script>
        let cy;
        let currentNetworkData = null;
        
        let extensionsLoaded = false;
        let availableLayouts = ['dagre', 'grid', 'circle', 'concentric'];
        
        // Wait for all scripts to load before initializing
        function waitForScripts() {
            return new Promise((resolve) => {
                if (typeof cytoscape !== 'undefined') {
                    // Register dagre extension (matching your other service)
                    if (typeof cytoscapeDagre !== 'undefined') {
                        try {
                            cytoscape.use(cytoscapeDagre);
                            extensionsLoaded = true;
                            console.log('Dagre extension loaded successfully');
                        } catch (e) {
                            console.warn('Failed to register dagre extension:', e);
                            // Remove dagre from available layouts if it failed to load
                            availableLayouts = availableLayouts.filter(layout => layout !== 'dagre');
                        }
                    } else {
                        console.warn('Dagre extension not found, using fallback layouts');
                        availableLayouts = availableLayouts.filter(layout => layout !== 'dagre');
                    }
                    resolve();
                } else {
                    console.error('Cytoscape not loaded');
                    resolve();
                }
            });
        }
        
        $(document).ready(async function() {
            await waitForScripts();
            loadAOPOptions();
            initializeCytoscape();
        });
        
        function loadAOPOptions() {
            $.get('/get_aop_options')
                .done(function(data) {
                    const select = $('#aop-select');
                    select.empty().append('<option value="">Select an Adverse Outcome Pathway...</option>');
                    
                    // Remove duplicates based on AOPpage URL to avoid duplicate entries
                    const uniqueAOPs = [];
                    const seenPages = new Set();
                    
                    data.forEach(function(aop) {
                        if (!seenPages.has(aop.AOPpage)) {
                            seenPages.add(aop.AOPpage);
                            uniqueAOPs.push(aop);
                        }
                    });
                    
                    // Sort by AOP title for better user experience
                    uniqueAOPs.sort((a, b) => a.AOPtitle.localeCompare(b.AOPtitle));
                    
                    uniqueAOPs.forEach(function(aop) {
                        const option = $('<option></option>')
                            .val(aop.AOPpage)
                            .text(aop.AOPtitle + ' (' + aop.AOPlabel + ')');
                        select.append(option);
                    });
                })
                .fail(function() {
                    showError('Failed to load AOP options. Please refresh the page.');
                });
        }
        
        function initializeCytoscape() {
            if (typeof cytoscape === 'undefined') {
                showError('Cytoscape library failed to load. Please refresh the page.');
                return;
            }
            
            try {
                cy = cytoscape({
                    container: document.getElementById('cy'),
                    
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': 'data(label)',
                                'color': '#000',
                                'font-size': 12,
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'width': 45,
                                'height': 45
                            }
                        },
                        {
                            selector: 'node[ke_type = "MIE"]',
                            style: {
                                'background-color': '#b3e6b3'
                            }
                        },
                        {
                            selector: 'node[ke_type = "AO"]',
                            style: {
                                'background-color': '#f4b3b3'
                            }
                        },
                        {
                            selector: 'node[ke_type = "intermediate"]',
                            style: {
                                'background-color': '#ffd9b3'
                            }
                        },
                        {
                            selector: '.gene-node',
                            style: {
                                'shape': 'ellipse',
                                'width': 40,
                                'height': 25,
                                'background-color': '#E5E7EB',
                                'border-width': 2,
                                'border-style': 'dashed',
                                'border-color': '#9CA3AF',
                                'label': 'data(label)',
                                'font-size': 10,
                                'text-valign': 'center',
                                'text-halign': 'center'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 2,
                                'line-color': '#999',
                                'target-arrow-color': '#999',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier'
                            }
                        },
                        {
                            selector: '.ke-gene-edge',
                            style: {
                                'line-style': 'dotted',
                                'line-color': '#9CA3AF',
                                'width': 1,
                                'target-arrow-shape': 'none'
                            }
                        },
                        {
                            selector: 'node:selected',
                            style: {
                                'border-width': 4,
                                'border-color': '#307BBF'
                            }
                        }
                    ],
                    
                    layout: {
                        name: 'dagre',  // Default to dagre layout matching your other service
                        rankDir: 'TB'   // Top to bottom direction
                    }
                });
                
                // Node click handler
                cy.on('tap', 'node', function(evt) {
                    const node = evt.target;
                    showNodeInfo(node.data());
                });
                
                console.log('Cytoscape initialized successfully with layout:', availableLayouts[0] || 'grid');
            } catch (e) {
                console.error('Failed to initialize Cytoscape:', e);
                showError('Failed to initialize network visualization. Please refresh the page.');
            }
        }
        
        $('#aop-select').change(function() {
            const aopId = $(this).val();
            if (aopId) {
                const includeGenes = $('#include-genes-toggle').is(':checked');
                loadAOPNetwork(aopId, includeGenes);
            } else {
                clearNetwork();
            }
        });
        
        function loadAOPNetwork(aopId, includeGenes = false) {
            showLoading(true);
            hideError();
            clearNetwork();
            
            // Build URL with parameters
            let url = '/get_aop_network/' + encodeURIComponent(aopId);
            const params = [];
            
            if (includeGenes) {
                params.push('include_genes=true');
            }
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            $.get(url)
                .done(function(data) {
                    displayNetwork(data);
                    // Use the cleaned data from displayNetwork for statistics
                    if (currentNetworkData) {
                        updateStatistics(currentNetworkData);
                        updateGeneStats(currentNetworkData);
                    }
                    showControls(true);
                    
                    // Auto-optimize layout after network loads
                    setTimeout(() => {
                        optimizeLayout();
                    }, 500);
                })
                .fail(function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to load network data';
                    showError(error);
                })
                .always(function() {
                    showLoading(false);
                });
        }
        
        function validateAndCleanNetworkData(data) {
            if (!data || !data.nodes || !data.edges) {
                return null;
            }
            
            // Create a set of valid node IDs for fast lookup
            // Handle both old format (direct id) and new format (data.id)
            const validNodeIds = new Set(data.nodes.map(node => 
                node.data ? node.data.id : node.id
            ));
            
            // Filter edges to only include those with valid source and target nodes
            const validEdges = data.edges.filter(edge => {
                // Handle both old format and new service format
                const source = edge.data ? edge.data.source : edge.source;
                const target = edge.data ? edge.data.target : edge.target;
                
                const hasValidSource = validNodeIds.has(source);
                const hasValidTarget = validNodeIds.has(target);
                
                if (!hasValidSource || !hasValidTarget) {
                    console.warn(`Filtering orphaned edge: ${source} -> ${target}`, {
                        validSource: hasValidSource,
                        validTarget: hasValidTarget
                    });
                    return false;
                }
                return true;
            });
            
            const filteredCount = data.edges.length - validEdges.length;
            if (filteredCount > 0) {
                console.log(`Filtered ${filteredCount} orphaned edges out of ${data.edges.length} total edges`);
            }
            
            return {
                ...data,
                edges: validEdges,
                edge_count: validEdges.length,
                filtered_edges: filteredCount
            };
        }
        
        function displayNetwork(data) {
            if (!cy || !data) {
                console.error('Cannot display network: Cytoscape not initialized or no data');
                showError('Network visualization not ready. Please refresh the page.');
                return;
            }
            
            try {
                // Validate and clean the network data
                const cleanData = validateAndCleanNetworkData(data);
                if (!cleanData) {
                    showError('Invalid network data received.');
                    return;
                }
                
                const elements = [];
                
                // Add nodes - now using the proper service format
                if (cleanData.nodes && Array.isArray(cleanData.nodes)) {
                    cleanData.nodes.forEach(function(node) {
                        // Handle both old format (direct properties) and new format (with data/classes)
                        if (node.data) {
                            // New service format
                            elements.push({
                                data: node.data,
                                classes: node.classes || ''
                            });
                        } else {
                            // Legacy format support
                            elements.push({
                                data: {
                                    id: node.id,
                                    label: node.label || node.title,
                                    title: node.title,
                                    bio_level: node.bio_level,
                                    ke_type: node.ke_type,
                                    ke_class: node.ke_class
                                }
                            });
                        }
                    });
                }
                
                // Add edges (now validated)
                if (cleanData.edges && Array.isArray(cleanData.edges)) {
                    cleanData.edges.forEach(function(edge, index) {
                        // Handle both old format and new service format
                        if (edge.data) {
                            // New service format
                            elements.push(edge);
                        } else {
                            // Legacy format support
                            elements.push({
                                data: {
                                    id: 'edge_' + index,
                                    source: edge.source,
                                    target: edge.target,
                                    type: edge.type
                                }
                            });
                        }
                    });
                }
                
                // Clear existing elements and add new ones
                cy.elements().remove();
                cy.add(elements);
                
                // Note: Layout optimization is now handled by auto-optimize in loadAOPNetwork
                
                // Update the current data reference with cleaned data
                currentNetworkData = cleanData;
                
                console.log(`Network displayed successfully:`);
                console.log(`- Nodes: ${cleanData.nodes?.length || 0}`);
                console.log(`- Valid edges: ${cleanData.edges?.length || 0}`);
                console.log(`- Filtered edges: ${cleanData.filtered_edges || 0}`);
                console.log(`- Layout: ${layoutName}`);
                
                // Show user feedback if edges were filtered
                if (cleanData.filtered_edges > 0) {
                    showError(`Network loaded with ${cleanData.filtered_edges} incomplete connections filtered out.`, 4000);
                }
            } catch (e) {
                console.error('Error displaying network:', e);
                showError('Failed to display network data.');
            }
        }
        
        // Old layout functions removed - now using dynamic optimization system
        
        function resetZoom() {
            cy.fit();
        }
        
        function updateStatistics(data) {
            // Use enhanced metadata from service if available
            if (data.metadata) {
                $('#node-count').text(data.node_count || 0);
                $('#edge-count').text(data.edge_count || 0);
                $('#mie-count').text(data.metadata.mie_count || 0);
                $('#ao-count').text(data.metadata.ao_count || 0);
            } else {
                // Fallback to manual calculation for legacy format
                const mieCount = data.nodes.filter(n => {
                    const ke_class = n.data ? n.data.ke_class : n.ke_class;
                    return ke_class === 'mie';
                }).length;
                const aoCount = data.nodes.filter(n => {
                    const ke_class = n.data ? n.data.ke_class : n.ke_class;
                    return ke_class === 'ao';
                }).length;
                
                $('#node-count').text(data.nodes?.length || 0);
                $('#edge-count').text(data.edges?.length || 0);
                $('#mie-count').text(mieCount);
                $('#ao-count').text(aoCount);
            }
            
            // Add filtered edge indicator if applicable
            if (data.filtered_edges > 0) {
                const edgeCountElement = $('#edge-count');
                edgeCountElement.attr('title', `${data.filtered_edges} incomplete connections were filtered out`);
                edgeCountElement.css('color', '#f59e0b'); // amber color to indicate filtering
            } else {
                // Reset styling if no filtering occurred
                const edgeCountElement = $('#edge-count');
                edgeCountElement.removeAttr('title');
                edgeCountElement.css('color', '');
            }
        }
        
        function showNodeInfo(nodeData) {
            $('#node-title').html('<strong>Title:</strong> ' + (nodeData.title || 'N/A'));
            $('#node-label').html('<strong>Label:</strong> ' + (nodeData.label || 'N/A'));
            $('#node-bio-level').html('<strong>Biological Level:</strong> ' + (nodeData.bio_level || 'N/A'));
            $('#node-type').html('<strong>Type:</strong> ' + (nodeData.ke_class.toUpperCase() || 'N/A'));
            $('#node-info').show();
        }
        
        function showLoading(show) {
            if (show) {
                $('#loading').show();
            } else {
                $('#loading').hide();
            }
        }
        
        function showError(message, duration = 0) {
            $('#error-message').text(message).show();
            if (duration > 0) {
                setTimeout(() => {
                    $('#error-message').hide();
                }, duration);
            }
        }
        
        function hideError() {
            $('#error-message').hide();
        }
        
        // Dynamic Layout Optimization Functions
        function optimizeLayout() {
            if (!cy || !cy.elements().length) {
                console.warn('Cannot optimize layout: No network data loaded');
                showLayoutStatus('No network data to optimize');
                return;
            }
            
            showLayoutProgress(true);
            showLayoutStatus('Analyzing network structure...');
            
            setTimeout(() => {
                const stats = analyzeNetworkStructure();
                const optimalLayout = selectOptimalLayout(stats);
                
                showLayoutStatus(`Applying ${optimalLayout.name} layout...`);
                
                try {
                    const layout = cy.layout(optimalLayout);
                    layout.run();
                    
                    layout.one('layoutstop', () => {
                        showLayoutProgress(false);
                        showLayoutStatus(`Layout optimized (${optimalLayout.name})`);
                        setTimeout(() => showLayoutStatus(''), 3000);
                    });
                } catch (e) {
                    console.error('Layout optimization failed:', e);
                    showLayoutProgress(false);
                    showLayoutStatus('Optimization failed - using default layout');
                    // Fallback
                    cy.layout({name: 'cose', animate: true}).run();
                }
            }, 100);
        }
        
        function analyzeNetworkStructure() {
            const nodes = cy.nodes().length;
            const edges = cy.edges().length;
            const geneNodes = cy.nodes('.gene-node').length;
            const keNodes = cy.nodes().not('.gene-node').length;
            
            return {
                totalNodes: nodes,
                keNodes: keNodes,
                geneNodes: geneNodes,
                edges: edges,
                density: nodes > 1 ? edges / (nodes * (nodes - 1) / 2) : 0,
                hasGenes: geneNodes > 0,
                geneRatio: nodes > 0 ? geneNodes / nodes : 0,
                complexity: nodes > 0 ? edges / nodes : 0
            };
        }
        
        function selectOptimalLayout(stats) {
            console.log('Network analysis:', stats);
            
            // Small networks: hierarchical if available
            if (stats.totalNodes <= 15 && availableLayouts.includes('dagre')) {
                return {
                    name: 'dagre',
                    directed: true,
                    animate: true,
                    animationDuration: 800,
                    rankDir: 'TB',
                    spacingFactor: 1.2
                };
            }
            
            // Gene-heavy networks: clustered force-directed
            if (stats.hasGenes && stats.geneRatio > 0.3) {
                return {
                    name: 'cose',
                    animate: true,
                    animationDuration: 1500,
                    nodeRepulsion: 12000,
                    idealEdgeLength: 60,
                    nodeOverlap: 10,
                    numIter: 1000
                };
            }
            
            // Large networks: optimized force-directed
            if (stats.totalNodes > 30) {
                return {
                    name: 'cose',
                    animate: true,
                    animationDuration: 1200,
                    nodeRepulsion: 8000,
                    idealEdgeLength: 80,
                    numIter: stats.totalNodes > 50 ? 1500 : 1000
                };
            }
            
            // Default: balanced cose layout
            return {
                name: 'cose',
                animate: true,
                animationDuration: 1000,
                nodeRepulsion: 10000,
                idealEdgeLength: 70
            };
        }
        
        function showLayoutProgress(show) {
            const btn = $('#optimize-layout-btn');
            const spinner = btn.find('.spinner');
            const text = btn.find('.btn-text');
            
            if (show) {
                btn.prop('disabled', true);
                spinner.show();
                text.text('Optimizing...');
            } else {
                btn.prop('disabled', false);
                spinner.hide();
                text.text('Optimize Layout');
            }
        }
        
        function showLayoutStatus(message) {
            $('#layout-status').text(message);
        }
        
        // Gene Integration Functions
        function setupGeneControls() {
            $('#include-genes-toggle').change(function() {
                const includeGenes = $(this).is(':checked');
                const aopId = $('#aop-select').val();
                
                if (aopId) {
                    loadAOPNetwork(aopId, includeGenes);
                }
            });
        }
        
        function updateGeneStats(data) {
            const geneCount = data.gene_count || 0;
            if (geneCount > 0) {
                $('#gene-count').text(geneCount);
                $('#gene-count-display').show();
                $('#gene-legend-item').show();
            } else {
                $('#gene-count-display').hide();
                $('#gene-legend-item').hide();
            }
        }
        
        // Export Functions
        function toggleExportDropdown() {
            const dropdown = $('#export-dropdown');
            dropdown.toggle();
        }
        
        function exportNetwork(format) {
            if (!cy || !cy.elements().length) {
                showExportStatus('No network data to export');
                return;
            }
            
            const timestamp = new Date().toISOString().slice(0,10);
            const aopId = $('#aop-select option:selected').text().replace(/[^a-zA-Z0-9]/g, '_');
            const filename = `aop_network_${aopId}_${timestamp}`;
            
            showExportStatus(`Exporting as ${format.toUpperCase()}...`);
            
            try {
                switch(format) {
                    case 'png':
                        const pngBlob = cy.png({
                            scale: 2,
                            full: true,
                            bg: 'white'
                        });
                        downloadDataUrl(pngBlob, `${filename}.png`);
                        break;
                        
                    case 'svg':
                        const svgContent = cy.svg({scale: 2, full: true});
                        downloadText(svgContent, `${filename}.svg`);
                        break;
                        
                    case 'json':
                        const networkData = {
                            nodes: cy.nodes().map(n => ({
                                data: n.data(),
                                classes: n.classes()
                            })),
                            edges: cy.edges().map(e => ({
                                data: e.data(),
                                classes: e.classes()
                            })),
                            metadata: currentNetworkData ? currentNetworkData.metadata : {},
                            exported_at: new Date().toISOString()
                        };
                        downloadJSON(networkData, `${filename}.json`);
                        break;
                        
                    case 'graphml':
                        const graphml = convertToGraphML(cy);
                        downloadText(graphml, `${filename}.graphml`);
                        break;
                }
                
                setTimeout(() => {
                    showExportStatus(`Exported as ${format.toUpperCase()}`);
                    setTimeout(() => showExportStatus(''), 2000);
                }, 500);
                
            } catch (e) {
                console.error('Export failed:', e);
                showExportStatus('Export failed');
            }
            
            // Hide dropdown
            $('#export-dropdown').hide();
        }
        
        function downloadDataUrl(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            link.click();
        }
        
        function downloadText(content, filename) {
            const blob = new Blob([content], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function downloadJSON(data, filename) {
            const content = JSON.stringify(data, null, 2);
            downloadText(content, filename);
        }
        
        function convertToGraphML(cy) {
            let graphml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            graphml += '<graphml xmlns="http://graphml.graphdrawing.org/xmlns">\n';
            graphml += '  <key id="label" for="node" attr.name="label" attr.type="string"/>\n';
            graphml += '  <key id="type" for="node" attr.name="type" attr.type="string"/>\n';
            graphml += '  <graph id="AOP_Network" edgedefault="directed">\n';
            
            // Add nodes
            cy.nodes().forEach(node => {
                const data = node.data();
                graphml += `    <node id="${data.id}">\n`;
                graphml += `      <data key="label">${data.label || data.id}</data>\n`;
                graphml += `      <data key="type">${data.type || 'ke'}</data>\n`;
                graphml += `    </node>\n`;
            });
            
            // Add edges
            cy.edges().forEach(edge => {
                const data = edge.data();
                graphml += `    <edge source="${data.source}" target="${data.target}"/>\n`;
            });
            
            graphml += '  </graph>\n';
            graphml += '</graphml>';
            
            return graphml;
        }
        
        function showExportStatus(message) {
            $('#export-status').text(message);
        }
        
        function showControls(show) {
            if (show) {
                $('#layout-controls').show();
                $('#gene-controls').show();
                $('#export-controls').show();
                $('#legend').show();
                $('#stats').show();
                
                // Setup gene controls if not already done
                setupGeneControls();
            } else {
                $('#layout-controls').hide();
                $('#gene-controls').hide();
                $('#export-controls').hide();
                $('#legend').hide();
                $('#stats').hide();
                $('#node-info').hide();
            }
        }
        
        function clearNetwork() {
            if (cy) {
                cy.elements().remove();
            }
            showControls(false);
            currentNetworkData = null;
        }
    </script>
</body>
</html>