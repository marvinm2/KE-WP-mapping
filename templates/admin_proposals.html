<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin: Manage Proposals</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    
    <!-- CSRF Token for AJAX requests -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <style>
        .proposal-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .proposal-actions button {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 80px;
        }
        
        .btn-approve {
            background-color: #28a745;
        }
        
        .btn-approve:hover {
            background-color: #218838;
        }
        
        .btn-reject {
            background-color: #dc3545;
        }
        
        .btn-reject:hover {
            background-color: #c82333;
        }
        
        .btn-view {
            background-color: #17a2b8;
        }
        
        .btn-view:hover {
            background-color: #138496;
        }
        
        .status-pending {
            color: #fd7e14;
            font-weight: bold;
        }
        
        .status-approved {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-rejected {
            color: #dc3545;
            font-weight: bold;
        }
        
        .proposal-detail {
            font-size: 13px;
            color: #666;
        }
        
        .filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #EB5B25 0%, #29235C 100%);
        }
    </style>
</head>
<body>
<div class="page-container">
    <header class="admin-header">
        <h1>üîß Admin: Proposal Management</h1>
        <nav style="display: flex; justify-content: center; gap: 20px; margin-top: 10px; flex-wrap: wrap; align-items: center;">
            <button onclick="location.href='/'">Back to Main App</button>
            <button onclick="location.href='/explore'">Explore Dataset</button>
            <div class="github-login">
                {% if user_info %}
                    <p>Admin: {{ user_info['username'] }}</p>
                    <a href="{{ url_for('auth.logout') }}">Logout</a>
                {% endif %}
            </div>
        </nav>        
    </header>
    
    <div class="container">
        {% if error %}
            <div style="color: red; font-weight: bold; margin: 20px 0;">
                Error: {{ error }}
            </div>
        {% endif %}
        
        <div class="filter-section">
            <h3>Filter Proposals</h3>
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <label>Status Filter:</label>
                <select id="statusFilter" onchange="filterProposals()">
                    <option value="all" {{ 'selected' if status_filter == 'all' else '' }}>All Proposals</option>
                    <option value="pending" {{ 'selected' if status_filter == 'pending' else '' }}>Pending Review</option>
                    <option value="approved" {{ 'selected' if status_filter == 'approved' else '' }}>Approved</option>
                    <option value="rejected" {{ 'selected' if status_filter == 'rejected' else '' }}>Rejected</option>
                </select>
                <span id="proposalCount" style="font-weight: bold; color: #307BBF;">
                    {{ proposals|length }} proposal(s) found
                </span>
            </div>
        </div>

        <div class="existing-entries-container">
            <h2>Proposal Management Dashboard</h2>
            <p>Review and manage user-submitted proposals for mapping changes.</p>
            
            <table id="proposalsTable" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Mapping</th>
                        <th>Proposed Changes</th>
                        <th>User Details</th>
                        <th>Status</th>
                        <th>Submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for proposal in proposals %}
                    <tr>
                        <td>{{ proposal.id }}</td>
                        <td>
                            <strong>{{ proposal.ke_id }}</strong> ‚Üí <strong>{{ proposal.wp_id }}</strong><br>
                            <div class="proposal-detail">
                                {{ proposal.ke_title }}<br>
                                ‚Üí {{ proposal.wp_title }}
                            </div>
                        </td>
                        <td>
                            {% if proposal.proposed_delete %}
                                <span style="color: #dc3545; font-weight: bold;">üóëÔ∏è DELETE MAPPING</span>
                            {% else %}
                                {% if proposal.proposed_confidence %}
                                    <div>Confidence: <strong>{{ proposal.current_confidence_level }}</strong> ‚Üí <strong>{{ proposal.proposed_confidence }}</strong></div>
                                {% endif %}
                                {% if proposal.proposed_connection_type %}
                                    <div>Type: <strong>{{ proposal.current_connection_type }}</strong> ‚Üí <strong>{{ proposal.proposed_connection_type }}</strong></div>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            <div><strong>{{ proposal.user_name }}</strong></div>
                            <div class="proposal-detail">{{ proposal.user_email }}</div>
                            <div class="proposal-detail">{{ proposal.user_affiliation }}</div>
                            <div class="proposal-detail">GitHub: {{ proposal.github_username }}</div>
                        </td>
                        <td>
                            <span class="status-{{ proposal.status }}">{{ proposal.status|title }}</span>
                            {% if proposal.admin_notes %}
                                <div class="proposal-detail">{{ proposal.admin_notes }}</div>
                            {% endif %}
                        </td>
                        <td>{{ proposal.created_at_formatted if proposal.created_at_formatted else 'Unknown' }}</td>
                        <td>
                            <div class="proposal-actions">
                                {% if proposal.status == 'pending' %}
                                    <button class="btn-approve" onclick="approveProposal({{ proposal.id }})">Approve</button>
                                    <button class="btn-reject" onclick="rejectProposal({{ proposal.id }})">Reject</button>
                                {% endif %}
                                <button class="btn-view" onclick="viewProposal({{ proposal.id }})">Details</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Proposal Detail Modal -->
    <div id="proposalModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; border: 1px solid #ccc; padding: 25px; border-radius: 10px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); width: 600px; max-height: 80vh; overflow-y: auto;">
        <h3 id="modalTitle">Proposal Details</h3>
        <div id="modalContent"></div>
        <div style="margin-top: 20px;">
            <textarea id="adminNotes" placeholder="Add admin notes (optional)" style="width: 100%; height: 80px; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
        </div>
        <div style="text-align: right;">
            <button onclick="closeModal()" class="btn-secondary">Close</button>
            <button id="modalApproveBtn" onclick="confirmApprove()" class="btn-approve" style="display: none;">Approve Proposal</button>
            <button id="modalRejectBtn" onclick="confirmReject()" class="btn-reject" style="display: none;">Reject Proposal</button>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;" onclick="closeModal()"></div>

    <footer>
        <p>&copy; 2025 KE-WP Mapping Service - Admin Panel</p>
    </footer>

    <script>
        let currentProposalId = null;
        
        // Setup CSRF token for all AJAX requests
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        $(document).ready(function() {
            $('#proposalsTable').DataTable({
                order: [[0, 'desc']], // Sort by ID descending (newest first)
                pageLength: 25,
                responsive: true,
                columnDefs: [
                    { width: '5%', targets: 0 },
                    { width: '25%', targets: 1 },
                    { width: '20%', targets: 2 },
                    { width: '20%', targets: 3 },
                    { width: '10%', targets: 4 },
                    { width: '10%', targets: 5 },
                    { width: '10%', targets: 6, orderable: false }
                ]
            });
        });

        function filterProposals() {
            const status = document.getElementById('statusFilter').value;
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('status', status);
            window.location = currentUrl.toString();
        }

        function viewProposal(proposalId) {
            currentProposalId = proposalId;
            
            $.get(`/admin/proposals/${proposalId}`)
                .done(function(proposal) {
                    showProposalModal(proposal);
                })
                .fail(function(xhr) {
                    alert('Error loading proposal: ' + (xhr.responseJSON?.error || 'Unknown error'));
                });
        }

        function showProposalModal(proposal) {
            const modal = document.getElementById('proposalModal');
            const overlay = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            const approveBtn = document.getElementById('modalApproveBtn');
            const rejectBtn = document.getElementById('modalRejectBtn');

            let changesHtml = '';
            if (proposal.proposed_delete) {
                changesHtml = '<div style="color: #dc3545; font-weight: bold; font-size: 16px;">üóëÔ∏è DELETE THIS MAPPING</div>';
            } else {
                if (proposal.proposed_confidence) {
                    changesHtml += `<div><strong>Confidence Level:</strong> ${proposal.current_confidence_level} ‚Üí <strong style="color: #307BBF;">${proposal.proposed_confidence}</strong></div>`;
                }
                if (proposal.proposed_connection_type) {
                    changesHtml += `<div><strong>Connection Type:</strong> ${proposal.current_connection_type} ‚Üí <strong style="color: #307BBF;">${proposal.proposed_connection_type}</strong></div>`;
                }
            }

            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>Mapping Information</h4>
                    <div><strong>KE ID:</strong> ${proposal.ke_id}</div>
                    <div><strong>KE Title:</strong> ${proposal.ke_title}</div>
                    <div><strong>WP ID:</strong> ${proposal.wp_id}</div>
                    <div><strong>WP Title:</strong> ${proposal.wp_title}</div>
                    <div><strong>Current Confidence:</strong> ${proposal.current_confidence_level}</div>
                    <div><strong>Current Connection:</strong> ${proposal.current_connection_type}</div>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <h4>Proposed Changes</h4>
                    ${changesHtml || '<div>No specific changes requested</div>'}
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>User Information</h4>
                    <div><strong>Name:</strong> ${proposal.user_name}</div>
                    <div><strong>Email:</strong> ${proposal.user_email}</div>
                    <div><strong>Affiliation:</strong> ${proposal.user_affiliation}</div>
                    <div><strong>GitHub:</strong> ${proposal.github_username}</div>
                    <div><strong>Submitted:</strong> ${proposal.created_at_formatted || proposal.created_at}</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <h4>Status</h4>
                    <div><strong>Current Status:</strong> <span class="status-${proposal.status}">${proposal.status.charAt(0).toUpperCase() + proposal.status.slice(1)}</span></div>
                    ${proposal.admin_notes ? `<div><strong>Admin Notes:</strong> ${proposal.admin_notes}</div>` : ''}
                    ${proposal.approved_by ? `<div><strong>Processed By:</strong> ${proposal.approved_by}</div>` : ''}
                    ${proposal.rejected_by ? `<div><strong>Processed By:</strong> ${proposal.rejected_by}</div>` : ''}
                </div>
            `;

            // Show action buttons only for pending proposals
            if (proposal.status === 'pending') {
                approveBtn.style.display = 'inline-block';
                rejectBtn.style.display = 'inline-block';
            } else {
                approveBtn.style.display = 'none';
                rejectBtn.style.display = 'none';
            }

            modal.style.display = 'block';
            overlay.style.display = 'block';
        }

        function approveProposal(proposalId) {
            if (confirm('Are you sure you want to approve this proposal? This will apply the changes to the mapping.')) {
                currentProposalId = proposalId;
                viewProposal(proposalId); // Show modal for admin notes
            }
        }

        function rejectProposal(proposalId) {
            if (confirm('Are you sure you want to reject this proposal?')) {
                currentProposalId = proposalId;
                viewProposal(proposalId); // Show modal for admin notes
            }
        }

        function confirmApprove() {
            if (!currentProposalId) return;
            
            const adminNotes = document.getElementById('adminNotes').value;
            const formData = new FormData();
            formData.append('admin_notes', adminNotes);
            formData.append('csrf_token', csrfToken);
            
            fetch(`/admin/proposals/${currentProposalId}/approve`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Success: ' + data.message);
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }

        function confirmReject() {
            if (!currentProposalId) return;
            
            const adminNotes = document.getElementById('adminNotes').value || 'No reason provided';
            const formData = new FormData();
            formData.append('admin_notes', adminNotes);
            formData.append('csrf_token', csrfToken);
            
            fetch(`/admin/proposals/${currentProposalId}/reject`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Success: ' + data.message);
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }

        function closeModal() {
            document.getElementById('proposalModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('adminNotes').value = '';
            currentProposalId = null;
        }
    </script>
</body>
</html>