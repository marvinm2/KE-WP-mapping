<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Dataset</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.print.min.js"></script>
    
    <!-- CSRF Token for AJAX requests -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
 
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #93D5F6;
            color: #29235C;
        }
        
        .dt-center {
            text-align: center;
        }
        
        .container {
            margin: 30px auto;
            max-width: 1200px;
            padding: 32px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
        }
        
        input[type="text"], input[type="email"], textarea {
            width: 100%;
            margin-bottom: 12px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            box-sizing: border-box;
            background-color: white;
            font-size: 14px;
            color: #29235C;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #307BBF;
            box-shadow: 0 0 0 3px rgba(48, 123, 191, 0.1);
            background-color: white;
        }

        .github-login {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .github-login p {
            margin: 0;
            color: #29235C;
            font-weight: 500;
        }

        .github-login a {
            color: #307BBF;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        .github-login a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body 
    data-is-logged-in="{{ 'true' if user_info else 'false' }}" 
    data-user-info='{{ user_info|tojson|safe }}'>


    <header>
        <h1>Explore KE-WP Dataset</h1>
        <nav style="display: flex; justify-content: center; gap: 20px; margin-top: 10px;">
            <button onclick="handleCtrlClick(event, '/')">Add New Mapping</button>
            <button onclick="handleCtrlClick(event, '/download')">Download Dataset</button>
            <div class="github-login">
                {% if session.get('user') %}
                    <p>Welcome, {{ session['user']['username'] }}</p>
                    <a href="{{ url_for('auth.logout') }}">Logout</a>
                {% else %}
                    <a href="{{ url_for('auth.login') }}">Login with GitHub</a>
                {% endif %}
            </div>
        </nav>
    </header>    
    <div class="container">
        <table id="datasetTable" class="display" width="100%">
            <thead>
                <tr>
                    <th>KE ID</th>
                    <th>KE Title</th>
                    <th>WP ID</th>
                    <th>WP Title</th>
                    <th>Connection Type</th>
                    <th>Confidence Level</th>
                    <th>Timestamp</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for row in dataset %}
                <tr>
                    <td>{{ row['ke_id'] or row['KE_ID'] }}</td>
                    <td>{{ row['ke_title'] or row['KE_Title'] }}</td>
                    <td>{{ row['wp_id'] or row['WP_ID'] }}</td>
                    <td>{{ row['wp_title'] or row['WP_Title'] }}</td>
                    <td>{{ row['connection_type'] or row['Connection_Type'] }}</td>
                    <td>{{ row['confidence_level'] or row['Confidence_Level'] }}</td>
                    <td>{{ (row['created_at'] or row['Timestamp'] or '').split('.')[0] }}</td>
                    <td>
                        <button class="propose-change" data-entry="{{ row }}">Propose Change</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Proposal Modal -->
    <div id="proposalModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; border: 1px solid #ccc; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); width: 500px;">
        {% if session.get('user') %}
        <form id="proposalForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <h3>Propose Changes to Mapping Entry</h3>
            <label for="entryDetails">Selected Entry Details:</label>
            <textarea id="entryDetails" readonly></textarea>
    
            <h4>Contact Information</h4>
            <label for="userName">Your Name:</label>
            <input type="text" id="userName" name="userName" placeholder="Enter your full name" required>
    
            <label for="userEmail">Email Address:</label>
            <input type="email" id="userEmail" name="userEmail" placeholder="Enter your email address" required>
    
            <label for="userAffiliation">Institution/Organization:</label>
            <input type="text" id="userAffiliation" name="userAffiliation" placeholder="Enter your affiliation" required>
    
            <h4>Suggested Changes</h4>
            <div>
                <input type="checkbox" id="deleteEntry" name="proposedChange" value="delete">
                <label for="deleteEntry">Recommend deletion of this mapping entry</label>
            </div>
            <div>
                <label><strong>Update Confidence Level:</strong></label><br>
                <input type="radio" id="confidenceHigh" name="changeConfidence" value="high">
                <label for="confidenceHigh">High Confidence</label><br>
                <input type="radio" id="confidenceMedium" name="changeConfidence" value="medium">
                <label for="confidenceMedium">Medium Confidence</label><br>
                <input type="radio" id="confidenceLow" name="changeConfidence" value="low">
                <label for="confidenceLow">Low Confidence</label>
            </div>
            <div>
                <label><strong>Update Connection Type:</strong></label><br>
                <input type="radio" id="typeCausative" name="changeType" value="causative">
                <label for="typeCausative">Causative (Pathway causes KE)</label><br>
                <input type="radio" id="typeResponsive" name="changeType" value="responsive">
                <label for="typeResponsive">Responsive (Pathway responds to KE)</label><br>
                <input type="radio" id="typeUndefined" name="changeType" value="undefined">
                <label for="typeUndefined">Undefined relationship</label>
            </div>
    
            <div style="text-align: right;">
                <button type="button" onclick="closeModal()">Cancel</button>
                <button type="submit">Submit Change Proposal</button>
            </div>
        </form>
        {% else %}
            <p style="text-align: center; color: #666; margin: 20px 0;">You must be logged in to propose changes to mapping entries.</p>
            <button id="loginButton" data-url="{{ url_for('auth.login') }}" style="display: block; margin: 0 auto;">Login with GitHub to Continue</button>
        {% endif %}
    </div>
    
    <!-- Overlay for Modal -->
    <div id="modalOverlay" style="display: none;" onclick="closeModal()"></div>
    <footer>
        <p>&copy; 2025 KE-WP Mapping Service</p>
    </footer>
    <script>
        $(document).ready(function () {
            // Setup DataTable
            $('#datasetTable').DataTable({
                dom: 'Bfrtip',
                buttons: ['csvHtml5', 'excelHtml5', 'pdfHtml5', 'print'],
                scrollX: true,
                autoWidth: false,
                order: [[6, 'desc']],
                columnDefs: [
                    { width: '10%', targets: 0, className: 'dt-center' },
                    { width: '20%', targets: 1, className: 'dt-center' },
                    { width: '10%', targets: 2, className: 'dt-center' },
                    { width: '20%', targets: 3, className: 'dt-center' },
                    { width: '15%', targets: 4, className: 'dt-center' },
                    { width: '15%', targets: 5, className: 'dt-center' },
                    { width: '10%', targets: 6, className: 'dt-center' }
                ]
            });
    
            // Handle Modal Actions
            $(".propose-change").click(function () {
                const entry = $(this).data("entry");
                $("#entryDetails").val(JSON.stringify(entry, null, 2));
                $("#proposalModal").show();
                $("#modalOverlay").show();
            });
        });
    
        function closeModal() {
            $("#proposalModal").hide();
            $("#modalOverlay").hide();
        }
    
        document.addEventListener('DOMContentLoaded', function () {
            
            // Function to autofill user data when modal is opened
            function autofillUserData() {
                // Retrieve user info and login status from attributes
                const userInfoAttr = document.body.getAttribute('data-user-info');
                const userInfo = userInfoAttr ? JSON.parse(userInfoAttr) : null;
                const isLoggedIn = document.body.getAttribute('data-is-logged-in') === 'true';

                console.log("User Info:", userInfo); // Log user info
                console.log("Is Logged In:", isLoggedIn); // Log login status

                // Autofill user details if logged in
                if (isLoggedIn && userInfo) {
                    const userNameField = document.getElementById('userName');
                    const userEmailField = document.getElementById('userEmail');

                    console.log("userNameField:", userNameField); // Log field access
                    console.log("userEmailField:", userEmailField); // Log field access

                    if (userNameField && userInfo.username) {
                        userNameField.value = userInfo.username;
                    }
                    if (userEmailField && userInfo.email) {
                        userEmailField.value = userInfo.email;
                    }
                } else {
                    console.warn("User is not logged in or user info is missing.");
                }
            }
      
    
            // Handle the "Propose Change" button click
            $(".propose-change").click(function () {
                const entry = $(this).data("entry");
                
                // Check login status
                const isLoggedIn = document.body.getAttribute('data-is-logged-in') === 'true';
    
                // Store entry data for form submission
                $("#proposalForm").data("entry", entry);
    
                // Populate entry details in the modal
                $("#entryDetails").val(JSON.stringify(entry, null, 2));
    
                if (!isLoggedIn) {
                    // Disable submit and show login prompt if not logged in
                    if (!$("#proposalModal .login-prompt").length) {
                        const loginPrompt = `<p class="login-prompt" style="color: red;">You need to log in to submit a proposal.</p>`;
                        $("#proposalModal").prepend(loginPrompt);
                    }
                    $("#proposalForm button[type='submit']").prop('disabled', true);
                } else {
                    $("#proposalForm button[type='submit']").prop('disabled', false);
                    $("#proposalModal .login-prompt").remove(); // Remove login prompt if present
                    // Autofill user data when modal opens and user is logged in
                    setTimeout(autofillUserData, 100);
                }
    
                // Show modal
                $("#proposalModal").show();
                $("#modalOverlay").show();
            });
    
            // Close modal
            $("#modalOverlay").on("click", closeModal);
    
            // Handle login button click
            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.addEventListener('click', function () {
                    const loginUrl = this.getAttribute('data-url');
                    window.location.href = loginUrl;
                });
            }

            // Handle proposal form submission
            $("#proposalForm").on('submit', function(e) {
                e.preventDefault();
                
                const form = $(this);
                const entryData = form.data("entry");
                
                if (!entryData) {
                    alert("Error: No entry data found");
                    return;
                }
                
                // Prepare form data
                const formData = new FormData();
                formData.append('entry', JSON.stringify(entryData));
                formData.append('userName', $('#userName').val());
                formData.append('userEmail', $('#userEmail').val());
                formData.append('userAffiliation', $('#userAffiliation').val());
                
                // Add CSRF token
                formData.append('csrf_token', $('input[name="csrf_token"]').val());
                
                // Handle checkbox and radio button values
                formData.append('deleteEntry', $('#deleteEntry').is(':checked') ? 'on' : '');
                formData.append('changeConfidence', $('input[name="changeConfidence"]:checked').val() || '');
                formData.append('changeType', $('input[name="changeType"]:checked').val() || '');
                
                // Debug form data
                console.log('Form data being sent:');
                for (let [key, value] of formData.entries()) {
                    console.log(key + ': ' + value);
                }
                
                // Submit the proposal
                $.ajax({
                    url: '/submit_proposal',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        alert('Success: ' + response.message);
                        closeModal();
                        // Reset form
                        document.getElementById('proposalForm').reset();
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.error || 'Failed to submit proposal';
                        alert('Error: ' + errorMsg);
                    }
                });
            });
        });
    </script>
    
</body>

</html>
