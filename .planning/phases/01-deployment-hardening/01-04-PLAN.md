---
phase: 01-deployment-hardening
plan: 04
type: execute
wave: 2
depends_on:
  - 01-03
files_modified:
  - app.py
autonomous: true
requirements:
  - DEPLOY-02
  - DEPLOY-04

must_haves:
  truths:
    - "With preload_app=True in gunicorn.conf.py, BioBERT loads in the Gunicorn master process before workers fork — not lazily on first request per worker"
    - "The warm-up call is guarded so it does not fire in testing or development environments (avoids BioBERT load in test suite)"
  artifacts:
    - path: "app.py"
      provides: "Module-level warm-up call for embedding_service guarded by FLASK_ENV=production"
      contains: "embedding_service"
  key_links:
    - from: "app.py"
      to: "src/services/container.py"
      via: "app.service_container.embedding_service access at module level"
      pattern: "service_container\\.embedding_service"
---

<objective>
Add a production-guarded warm-up call that forces BioBERT to initialize in the Gunicorn master process before workers fork, ensuring preload_app=True is effective.

Purpose: Plan 03 established that embedding files are now NPZ (DEPLOY-02/04). The Gunicorn config in Plan 02 sets `preload_app=True` (DEPLOY-02). However, `ServiceContainer.embedding_service` is lazy — it only loads BioBERT on first access. Without an explicit warm-up call at module level in app.py, the model loads per-worker on the first request, defeating the memory-sharing benefit of preload_app. This plan completes the preload chain.

Output: app.py with a module-level warm-up call that fires only when FLASK_ENV=production and embeddings are enabled.
</objective>

<execution_context>
@/home/marvin/.claude/get-shit-done/workflows/execute-plan.md
@/home/marvin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-deployment-hardening/01-RESEARCH.md
@.planning/phases/01-deployment-hardening/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add production-guarded embedding warm-up call in app.py</name>
  <files>app.py</files>
  <action>
    In `app.py`, after the module-level `app = create_app()` line (currently line 196), add a warm-up block that forces `embedding_service` to initialize in the Gunicorn master process before workers fork.

    Current code at the bottom of app.py (lines 195–204):
    ```python
    # Create application instance for gunicorn/uwsgi
    app = create_app()

    if __name__ == "__main__":
        # Development server configuration
        debug_mode = os.getenv("FLASK_DEBUG", "False").lower() == "true"
        port = int(os.getenv("PORT", 5000))
        host = os.getenv("HOST", "127.0.0.1")

        app.run(debug=debug_mode, host=host, port=port)
    ```

    Replace with:
    ```python
    # Create application instance for gunicorn/uwsgi
    app = create_app()

    # Warm up embedding service for Gunicorn preload_app=True.
    # With preload_app, Gunicorn imports this module in the master process before forking workers.
    # ServiceContainer.embedding_service is lazy — accessing it here forces BioBERT to load
    # in the master, so workers inherit the loaded model via Linux fork copy-on-write.
    # Guard: only fire in production to avoid loading BioBERT during tests or dev server startup.
    if os.getenv("FLASK_ENV") == "production":
        try:
            _svc = app.service_container.embedding_service
            if _svc is not None:
                logger.info("Embedding service pre-loaded for Gunicorn worker fork (preload_app=True)")
            else:
                logger.info("Embedding service disabled by config — skipping preload warm-up")
        except Exception as _e:
            logger.warning("Embedding service warm-up failed (non-fatal): %s", _e)

    if __name__ == "__main__":
        # Development server configuration
        debug_mode = os.getenv("FLASK_DEBUG", "False").lower() == "true"
        port = int(os.getenv("PORT", 5000))
        host = os.getenv("HOST", "127.0.0.1")

        app.run(debug=debug_mode, host=host, port=port)
    ```

    Rationale:
    - The guard `if os.getenv("FLASK_ENV") == "production"` prevents BioBERT from loading during `python -m pytest` (tests set FLASK_ENV=testing) or plain `python app.py` (FLASK_ENV defaults to development).
    - The `except Exception` catch is intentional — a warm-up failure is not fatal; the app can still start and workers will lazy-load BioBERT on first request (slower but functional).
    - `_svc` and `_e` use underscore prefix to minimize namespace pollution.
    - The `logger` variable is already defined at module level in app.py (line 40).
  </action>
  <verify>
    Confirm the warm-up block is present and guarded correctly:
    ```bash
    grep -n "FLASK_ENV.*production\|embedding_service\|preload" \
        /home/marvin/Documents/Services/Ke-gene-mapping/KE-WP-mapping/app.py
    ```
    Expected: lines showing the FLASK_ENV production guard and embedding_service access.

    Confirm the app still imports cleanly in non-production mode (no BioBERT load):
    ```bash
    cd /home/marvin/Documents/Services/Ke-gene-mapping/KE-WP-mapping
    FLASK_ENV=testing python -c "
    import os
    os.environ['FLASK_ENV'] = 'testing'
    # TestingConfig skips validation, so no OAuth secrets needed
    from src.core.config import TestingConfig
    print('Config OK, DATABASE_PATH:', TestingConfig().DATABASE_PATH)
    " 2>&1
    ```

    Confirm the warm-up block guard means FLASK_ENV=testing does NOT trigger it:
    ```bash
    python -c "
    import os
    flask_env = 'testing'
    fired = flask_env == 'production'
    print('Warm-up would fire in testing:', fired)  # Expected: False
    assert not fired, 'GUARD BROKEN'
    print('Guard OK')
    "
    ```
  </verify>
  <done>app.py contains a production-guarded warm-up call that accesses `app.service_container.embedding_service` at module level; guard prevents firing in test/dev environments; app imports cleanly without BioBERT load in non-production.</done>
</task>

</tasks>

<verification>
Run the test suite to confirm the warm-up call does not break tests:

```bash
cd /home/marvin/Documents/Services/Ke-gene-mapping/KE-WP-mapping && python -m pytest tests/ -x -q 2>&1 | head -40
```

The FLASK_ENV in tests is `testing` (set by TestingConfig), so the warm-up block guard `if os.getenv("FLASK_ENV") == "production"` will not fire. Tests should pass unchanged.
</verification>

<success_criteria>
- `app.py` contains a warm-up block after `app = create_app()` that accesses `app.service_container.embedding_service`
- Warm-up block is guarded by `if os.getenv("FLASK_ENV") == "production"` — does not fire in test/dev
- Warm-up block has a try/except so startup failure is non-fatal
- Test suite passes without modification
</success_criteria>

<output>
After completion, create `.planning/phases/01-deployment-hardening/01-04-SUMMARY.md` with:
- What was changed and why
- Verification results confirming guard works correctly
- Any unexpected findings

This is the final plan in Phase 1. Note in the summary: embedding files on disk (.npy files in data/) must be regenerated using the updated precompute scripts before deploying, as the new format is .npz. The old .npy files can be deleted once new .npz files are confirmed working.
</output>
